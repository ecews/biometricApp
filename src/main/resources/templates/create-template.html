<!doctype html>
<html lang="en" xmlns:th="https://www.thymeleaf.com">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <link href="/css/bootstrap.min.css" rel="stylesheet" >
    <title>Biometric App</title>
  </head>
  <body>
   
   
   <nav class="navbar navbar-expand-lg navbar-light bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand text-white" href="#">Biometric App</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active text-white" aria-current="page" href="/">Home</a>
        </li>
          <li class="nav-item">
              <a class="nav-link text-white" href="recapture-status">Recapture Status</a>
          </li>
          <li class="nav-item">
              <a class="nav-link text-white" href="deduplication">Deduplication</a>
          </li>
          <li class="nav-item">
              <a class="nav-link text-white" href="reports">Reports</a>
          </li>
          <li class="nav-item">
              <a class="nav-link text-white" href="capturing">Capture Biometric</a>
          </li>
          <!--<li class="nav-item">
              <a class="nav-link text-white" href="replacement">Replacement</a>
          </li>-->
          <li class="nav-item dropdown">
              <a class="nav-link  dropdown-toggle text-white" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">NDR</a>
              <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="generate_xml">Generate XML</a></li>
                  <li><a class="dropdown-item" href="download_xml">Download XML</a></li>
              </ul>
          </li>
      </ul>
      <div>
          <span class="navbar-text text-white">
              Version: 1.0.3
          </span>
      		 <!--<a class="nav-link text-white" href="book_register">New Book Register</a>-->
      </div>
    </div>
  </div>
</nav>

   <div class="container text-center my-5">
   		<h1>TEMPLATE CREATION</h1>

       <div id="inProcess" class="alert alert-info" role="alert" style="display: none;">
           <label>Creation in process ... </label>
       </div>
       <div id="inProcessDownload" class="alert alert-info" role="alert" style="display: none;">
           <label>Download in process ... </label>
       </div>
       <div id="inProcessUpload" class="alert alert-info" role="alert" style="display: none;">
           <label>Upload in process ... </label>
       </div>
       <div id="success" style="display: none;" class="alert alert-success alert-dismissible fade show" role="alert">
           <label>Done with creation</label>
           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
       </div>
       <div id="successDownload" style="display: none;" class="alert alert-success alert-dismissible fade show" role="alert">
           <label>Download completed</label>
           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
       </div>
       <div id="successUpload" style="display: none;" class="alert alert-success alert-dismissible fade show" role="alert">
           <label>Upload completed</label>
           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
       </div>

       <div id="failure" style="display: none;" class="alert alert-danger alert-dismissible fade show" role="alert">
           <label>Done with creation</label>
           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
       </div>

       <div class="row row text-center mt-5 w-50 m-auto">
           <div class="mb-3">
               <div class="col">
                   <input id="file" name="file" class="form-control form-control-lg" type="file">
               </div>
               <div class="col mt-3" >
                   <input id="fileName" class="form-control" type="text" placeholder="Enter file name" aria-label="default input example">
               </div>
           </div>
           <div class="mb-3 col row">
               <div class="col">
                   <button id="createTemplate" type="button" class="btn btn-primary">Create Template</button>
               </div>
               <div class="col">
                   <button id="downloadTemplate" type="button" class="btn btn-outline-info">Download Template</button>
               </div>
               <div class="col">
                   <button id="uploadTemplate" type="button" class="btn btn-outline-primary">Upload Template</button>
               </div>
           </div>

           <div class="mb-3">

           </div>
       </div>

   </div>

   <script src="/js/bootstrap.bundle.min.js" ></script>
   <script src="/js/jquery-3.7.1.min.js" ></script>

   <script type="text/javascript">
       $(document).ready(function() {

           $('#uploadTemplate').click(function() {
               if($('#file').val()) {
                   document.getElementById("inProcessUpload").style.display = "block";
                   document.getElementById("uploadTemplate").disabled = true
                   // Get the file input element
                   var fileInput = document.getElementById('file');
                   // Get the file object
                   var file = fileInput.files[0];
                   // Create a FormData object
                   var formData = new FormData();
                   // Append the file to the FormData object
                   formData.append('file', file);
                   // Send the file to the server using AJAX
                   $.ajax({
                       url: '/api/v1/biometric/upload-template', // Your server-side endpoint
                       type: 'POST',
                       data: formData,
                       processData: false, // Prevent jQuery from processing the data
                       contentType: false, // Set content type to false to prevent jQuery from setting Content-Type
                       success: function(response) {
                           document.getElementById("uploadTemplate").disabled = false;
                           document.getElementById("inProcessUpload").style.display = "none";
                           document.getElementById("successUpload").style.display = "block";
                           $('#file').val("");
                           // Handle successful upload
                           console.log(response);
                       },
                       error: function(xhr, status, error) {
                           document.getElementById("inProcess").style.display = "none";
                           $('#uploadTemplate').attr('enabled','enabled');
                           // Handle upload error
                           console.error('Upload failed:', error);
                       },
                       xhr: function() {
                           // Create custom XHR to track upload progress
                           var xhr = $.ajaxSettings.xhr();
                           xhr.upload.onprogress = function(event) {
                               var percentComplete = (event.loaded / event.total) * 100;
                               console.log('Upload progress: ' + percentComplete.toFixed(2) + '%');
                           };
                           return xhr;
                       }
                   });
               }else {
                   alert('No file selected ')
               }
           });
           // Event listener for the upload button
           $('#createTemplate').click(function() {
               if($('#file').val()) {
                   document.getElementById("inProcess").style.display = "block";
                   $('#createTemplate').attr('disabled','disabled');
                   // Get the file input element
                   var fileInput = document.getElementById('file');
                   // Get the file object
                   var file = fileInput.files[0];
                   // Create a FormData object
                   var formData = new FormData();
                   // Append the file to the FormData object
                   formData.append('file', file);
                   // Send the file to the server using AJAX
                   $.ajax({
                       url: '/api/v1/biometric/create-template', // Your server-side endpoint
                       type: 'POST',
                       data: formData,
                       processData: false, // Prevent jQuery from processing the data
                       contentType: false, // Set content type to false to prevent jQuery from setting Content-Type
                       success: function(response) {
                           // Handle successful upload
                           console.log(response);
                           $('#createTemplate').attr('enabled','enabled');
                           document.getElementById("inProcess").style.display = "none";
                           document.getElementById("success").style.display = "block";
                       },
                       error: function(xhr, status, error) {
                           document.getElementById("inProcess").style.display = "none";
                           $('#createTemplate').attr('enabled','enabled');
                           // Handle upload error
                           console.error('Upload failed ******* ');
                       },
                       xhr: function() {
                           // Create custom XHR to track upload progress
                           var xhr = $.ajaxSettings.xhr();
                           xhr.upload.onprogress = function(event) {
                               var percentComplete = (event.loaded / event.total) * 100;
                               console.log('Upload progress: ' + percentComplete.toFixed(2) + '%');
                           };
                           return xhr;
                       }
                   });
               }else {
                   alert('No file selected ')
               }
           });

           $('#downloadTemplate').click(function() {
               const fileName = $('#fileName').val()
               if(fileName) {
                   download(fileName)
               }else {
                   alert("File name is blank")
               }
           })
       });
       function download(filename) {
           document.getElementById("inProcessDownload").style.display = "block";
           var fileInput = document.getElementById('file');
           var file = fileInput.files[0]
           var formData = new FormData();

           formData.append('file', file);
           const xhr = new XMLHttpRequest();
           xhr.open("POST", "/api/v1/biometric/download-template/" + filename, true);

           xhr.onload = function() {
               if (this.status === 200) {
                   document.getElementById("inProcessDownload").style.display = "none";
                   document.getElementById("successDownload").style.display = "block";
                   const blob = new Blob([xhr.response], {type: "application/octet-stream"});
                   const url = window.URL.createObjectURL(blob);
                   const a = document.createElement("a");
                   a.href = url;
                   a.download = filename + '.json';
                   document.body.appendChild(a);
                   a.click();
                   window.URL.revokeObjectURL(url);
                   document.body.removeChild(a);
               } else {
                   console.error("Failed to download file");document.getElementById("inProcessDownload").style.display = "none";

               }
           };

           xhr.send(formData);
       }

   </script>

  </body>
</html>